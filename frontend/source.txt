activity_details.xml: 
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:gravity="center_horizontal"
    android:orientation="vertical"
    android:padding="32dp">

    <ImageView
        android:id="@+id/imgDetailIcon"
        android:layout_width="120dp"
        android:layout_height="120dp"
        android:src="@mipmap/ic_launcher" />

    <TextView
        android:id="@+id/tvDetailName"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="16dp"
        android:text="App Name"
        android:textSize="28sp"
        android:textStyle="bold" />

    <TextView
        android:id="@+id/tvDetailVersion"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="Latest: v1.0"
        android:textColor="#666" />

    <TextView
        android:id="@+id/tvInstalledVersion"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="4dp"
        android:text="Installed: Checking..."
        android:textColor="#666"
        android:textStyle="italic" />

    <ProgressBar
        android:id="@+id/progressBar"
        style="?android:attr/progressBarStyleHorizontal"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="32dp"
        android:indeterminate="false"
        android:max="100"
        android:visibility="invisible" />

    <TextView
        android:id="@+id/tvStatus"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="4dp"
        android:text="0%"
        android:textSize="12sp"
        android:visibility="invisible"/>

    <Button
        android:id="@+id/btnAction"
        android:layout_width="match_parent"
        android:layout_height="60dp"
        android:layout_marginTop="16dp"
        android:text="Check Status" />

</LinearLayout>

activity_main.xml: 
<?xml version="1.0" encoding="utf-8"?>
<androidx.constraintlayout.widget.ConstraintLayout
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:padding="16dp">

    <TextView
        android:id="@+id/tvTitle"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Magazine"
        android:textSize="24sp"
        android:textStyle="bold"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toTopOf="parent" />

    <androidx.recyclerview.widget.RecyclerView
        android:id="@+id/recyclerView"
        android:layout_width="0dp"
        android:layout_height="0dp"
        android:layout_marginTop="16dp"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toBottomOf="@id/tvTitle" />

    <ProgressBar
        android:id="@+id/mainProgressBar"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:visibility="gone"
        app:layout_constraintTop_toTopOf="parent"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintEnd_toEndOf="parent" />

    <com.google.android.material.floatingactionbutton.FloatingActionButton
        android:id="@+id/btnRefresh"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_margin="16dp"
        android:src="@android:drawable/ic_popup_sync"
        android:contentDescription="Refresh"
        app:backgroundTint="#2196F3"
        app:tint="#FFFFFF"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintEnd_toEndOf="parent" />

</androidx.constraintlayout.widget.ConstraintLayout>

item_app.xml: 
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical"
    android:gravity="center"
    android:padding="16dp">

    <ImageView
        android:id="@+id/imgIcon"
        android:layout_width="64dp"
        android:layout_height="64dp"
        android:src="@mipmap/ic_launcher" />

    <TextView
        android:id="@+id/tvAppName"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="App Name"
        android:textStyle="bold" />
</LinearLayout>

DetailsActivity.kt: 
package com.dendy.market

import android.annotation.SuppressLint
import android.app.DownloadManager
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.IntentFilter
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.os.Environment
import android.view.View
import android.widget.Button
import android.widget.ImageView
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.content.FileProvider
import androidx.lifecycle.lifecycleScope
import coil.load
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import kotlinx.coroutines.isActive
import kotlinx.coroutines.launch
import java.io.File

class DetailsActivity : AppCompatActivity() {

    private lateinit var appData: AppModel
    private lateinit var btnAction: Button
    private lateinit var progressBar: ProgressBar
    private lateinit var tvStatus: TextView
    private lateinit var tvInstalledVersion: TextView
    private var progressJob: Job? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_details)

        // Retrieve data passed from Main Activity
        appData = intent.getSerializableExtra("APP_DATA") as AppModel

        // Bind Views
        val imgIcon = findViewById<ImageView>(R.id.imgDetailIcon)
        val tvName = findViewById<TextView>(R.id.tvDetailName)
        val tvVersion = findViewById<TextView>(R.id.tvDetailVersion)
        tvInstalledVersion = findViewById(R.id.tvInstalledVersion)
        btnAction = findViewById(R.id.btnAction)
        progressBar = findViewById(R.id.progressBar)
        tvStatus = findViewById(R.id.tvStatus)

        // Set Static Data
        tvName.text = appData.name
        tvVersion.text = "Latest Version: ${appData.version}"
        imgIcon.load(BASE_URL + appData.iconUrl)

        // Initial State Check
        refreshUiState()

        // Register Receiver (Fixed for Android 14+)
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            registerReceiver(onDownloadComplete, IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE), Context.RECEIVER_EXPORTED)
        } else {
            registerReceiver(onDownloadComplete, IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE))
        }
    }

    override fun onResume() {
        super.onResume()
        // Refresh state when returning to the app (e.g. after installing)
        refreshUiState()
    }

    override fun onDestroy() {
        super.onDestroy()
        progressJob?.cancel()
        unregisterReceiver(onDownloadComplete)
    }

    // --- MAIN LOGIC ---

    private fun refreshUiState() {
        // 1. Check if we are currently downloading
        if (DownloadController.isDownloading(appData.packageName)) {
            setupDownloadingState()
            return
        }

        // 2. Reset specific download UI elements if idle
        progressBar.visibility = View.INVISIBLE
        tvStatus.visibility = View.INVISIBLE
        progressJob?.cancel()

        // 3. Get currently installed data
        val installedCode = getInstalledVersionCode(appData.packageName)
        val installedVerName = getInstalledVersionName(appData.packageName)
        val fileExists = apkFileExists()

        // 4. Update the "Installed: ..." text
        if (installedCode == -1) {
            tvInstalledVersion.text = "Installed: Not Installed"
        } else {
            tvInstalledVersion.text = "Installed: $installedVerName (Code: $installedCode)"
        }

        // 5. Determine Button State
        if (installedCode == -1) {
            // --- NOT INSTALLED ---
            if (fileExists) {
                // File exists -> "INSTALL"
                btnAction.text = "INSTALL"
                btnAction.isEnabled = true
                btnAction.setOnClickListener { installApk() }
            } else {
                // No file -> "DOWNLOAD"
                btnAction.text = "DOWNLOAD"
                btnAction.isEnabled = true
                btnAction.setOnClickListener { startDownload() }
            }
        } else {
            // --- INSTALLED ---
            if (appData.versionCode > installedCode) {
                // Server version is newer -> "UPDATE"
                btnAction.text = "UPDATE"
                btnAction.isEnabled = true
                btnAction.setOnClickListener { startDownload() }
            } else {
                // App is up to date -> "CHECK FOR UPDATES"
                btnAction.text = "CHECK FOR UPDATES"
                btnAction.isEnabled = true
                btnAction.setOnClickListener {
                    if (appData.versionCode > installedCode) {
                        refreshUiState()
                    } else {
                        Toast.makeText(this, "App is up to date!", Toast.LENGTH_SHORT).show()
                    }
                }
            }
        }
    }

    private fun setupDownloadingState() {
        btnAction.text = "Downloading..."
        btnAction.isEnabled = false
        progressBar.visibility = View.VISIBLE
        tvStatus.visibility = View.VISIBLE
        startProgressPoller()
    }

    // --- DOWNLOAD & INSTALLATION ---

    private fun startDownload() {
        deleteExistingApk() // Clear old files first

        Toast.makeText(this, "Starting Download...", Toast.LENGTH_SHORT).show()

        val fullDownloadUrl = BASE_URL + appData.downloadUrl
        val fileName = "${appData.packageName}.apk"

        val request = DownloadManager.Request(Uri.parse(fullDownloadUrl))
            .setTitle(appData.name)
            .setDescription("Downloading...")
            .setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE)
            .setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, fileName)
            .setMimeType("application/vnd.android.package-archive")

        val manager = getSystemService(Context.DOWNLOAD_SERVICE) as DownloadManager
        val downloadId = manager.enqueue(request)

        DownloadController.trackDownload(appData.packageName, downloadId)
        refreshUiState()
    }

    private fun deleteExistingApk() {
        val fileName = "${appData.packageName}.apk"
        val file = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), fileName)
        if (file.exists()) {
            file.delete()
        }
    }

    private fun installApk() {
        val fileName = "${appData.packageName}.apk"
        val file = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), fileName)

        if (file.exists()) {
            val uri = FileProvider.getUriForFile(this, "${applicationContext.packageName}.provider", file)
            val intent = Intent(Intent.ACTION_VIEW).apply {
                setDataAndType(uri, "application/vnd.android.package-archive")
                addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            startActivity(intent)
        } else {
            Toast.makeText(this, "Error: File not found. Downloading again...", Toast.LENGTH_SHORT).show()
            // Fallback: If file is missing for some reason, download it again
            startDownload()
        }
    }

    // --- PROGRESS POLLING ---

    @SuppressLint("Range")
    private fun startProgressPoller() {
        if (progressJob?.isActive == true) return

        val downloadId = DownloadController.getDownloadId(appData.packageName) ?: return
        val manager = getSystemService(Context.DOWNLOAD_SERVICE) as DownloadManager

        progressJob = lifecycleScope.launch {
            while (isActive) {
                val query = DownloadManager.Query().setFilterById(downloadId)
                val cursor = manager.query(query)

                if (cursor.moveToFirst()) {
                    val status = cursor.getInt(cursor.getColumnIndex(DownloadManager.COLUMN_STATUS))

                    if (status == DownloadManager.STATUS_SUCCESSFUL) {
                        progressBar.progress = 100
                        tvStatus.text = "100%"
                        btnAction.text = "Installing..."
                        // We wait for the BroadcastReceiver to trigger the final state change
                        break
                    } else if (status == DownloadManager.STATUS_FAILED) {
                        btnAction.text = "Retry"
                        btnAction.isEnabled = true
                        DownloadController.clearDownload(appData.packageName)
                        break
                    } else {
                        // Update Progress
                        val bytesDownloaded = cursor.getLong(cursor.getColumnIndex(DownloadManager.COLUMN_BYTES_DOWNLOADED_SO_FAR))
                        val bytesTotal = cursor.getLong(cursor.getColumnIndex(DownloadManager.COLUMN_TOTAL_SIZE_BYTES))

                        if (bytesTotal > 0) {
                            val progress = ((bytesDownloaded * 100L) / bytesTotal).toInt()
                            progressBar.progress = progress
                            tvStatus.text = "$progress%"
                        }
                    }
                } else {
                    // Download lost
                    DownloadController.clearDownload(appData.packageName)
                    refreshUiState()
                    break
                }
                cursor.close()
                delay(500) // Update every half second
            }
        }
    }

    // --- SYSTEM EVENTS & HELPERS ---

    private val onDownloadComplete = object : BroadcastReceiver() {
        override fun onReceive(context: Context, intent: Intent) {
            val id = intent.getLongExtra(DownloadManager.EXTRA_DOWNLOAD_ID, -1)
            // Verify this download belongs to this specific app page
            if (id == DownloadController.getDownloadId(appData.packageName)) {
                DownloadController.clearDownload(appData.packageName)
                installApk()
                refreshUiState()
            }
        }
    }

    private fun apkFileExists(): Boolean {
        val fileName = "${appData.packageName}.apk"
        val file = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), fileName)
        return file.exists()
    }

    private fun getInstalledVersionCode(packageName: String): Int {
        return try {
            val pInfo = packageManager.getPackageInfo(packageName, 0)
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {
                pInfo.longVersionCode.toInt()
            } else {
                pInfo.versionCode
            }
        } catch (e: PackageManager.NameNotFoundException) {
            -1
        }
    }

    private fun getInstalledVersionName(packageName: String): String {
        return try {
            val pInfo = packageManager.getPackageInfo(packageName, 0)
            // Fix: If pInfo.versionName is null, return "N/A" instead
            pInfo.versionName ?: "N/A"
        } catch (e: PackageManager.NameNotFoundException) {
            "N/A"
        }
    }
}

DownloadController.kt: 
package com.dendy.market

object DownloadController {
    // Maps Package Name -> DownloadManager ID
    private val activeDownloads = mutableMapOf<String, Long>()

    fun isDownloading(packageName: String): Boolean {
        return activeDownloads.containsKey(packageName)
    }

    fun getDownloadId(packageName: String): Long? {
        return activeDownloads[packageName]
    }

    fun trackDownload(packageName: String, id: Long) {
        activeDownloads[packageName] = id
    }

    fun clearDownload(packageName: String) {
        activeDownloads.remove(packageName)
    }
}

MainActivity.kt: 
package com.dendy.market

import android.content.Intent
import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ImageView
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.GridLayoutManager
import androidx.recyclerview.widget.RecyclerView
import coil.load
import com.google.android.material.floatingactionbutton.FloatingActionButton
import kotlinx.coroutines.launch

class MainActivity : AppCompatActivity() {

    private lateinit var recycler: RecyclerView
    private lateinit var progressBar: ProgressBar
    private lateinit var btnRefresh: FloatingActionButton

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        recycler = findViewById(R.id.recyclerView)
        progressBar = findViewById(R.id.mainProgressBar)
        btnRefresh = findViewById(R.id.btnRefresh)

        recycler.layoutManager = GridLayoutManager(this, 3)

        // Initial Load
        loadApps()

        // Button Listener
        btnRefresh.setOnClickListener {
            loadApps()
        }
    }

    private fun loadApps() {
        // Show loading state
        progressBar.visibility = View.VISIBLE
        btnRefresh.isEnabled = false // Prevent spamming
        recycler.alpha = 0.5f // Dim the list slightly while loading

        lifecycleScope.launch {
            try {
                val apps = RetrofitClient.api.getApps()

                // Update Adapter
                recycler.adapter = AppsAdapter(apps) { app ->
                    val intent = Intent(this@MainActivity, DetailsActivity::class.java)
                    intent.putExtra("APP_DATA", app)
                    startActivity(intent)
                }
            } catch (e: Exception) {
                e.printStackTrace()
                Toast.makeText(this@MainActivity, "Failed to connect to store", Toast.LENGTH_SHORT).show()
            } finally {
                // Restore UI state
                progressBar.visibility = View.GONE
                btnRefresh.isEnabled = true
                recycler.alpha = 1.0f
            }
        }
    }

    // (Adapter class remains unchanged from previous version)
    class AppsAdapter(
        private val apps: List<AppModel>,
        private val onClick: (AppModel) -> Unit
    ) : RecyclerView.Adapter<AppsAdapter.Holder>() {

        class Holder(v: View) : RecyclerView.ViewHolder(v) {
            val icon: ImageView = v.findViewById(R.id.imgIcon)
            val name: TextView = v.findViewById(R.id.tvAppName)
        }

        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): Holder {
            val v = LayoutInflater.from(parent.context).inflate(R.layout.item_app, parent, false)
            return Holder(v)
        }

        override fun onBindViewHolder(holder: Holder, position: Int) {
            val app = apps[position]
            holder.name.text = app.name
            val fullIconUrl = BASE_URL + app.iconUrl
            holder.icon.load(fullIconUrl)
            holder.itemView.setOnClickListener { onClick(app) }
        }

        override fun getItemCount() = apps.size
    }
}

Network.kt: 
package com.dendy.market

import com.google.gson.annotations.SerializedName
import retrofit2.Retrofit
import retrofit2.converter.gson.GsonConverterFactory
import retrofit2.http.GET

// --- CONFIGURATION ---
const val BASE_URL = "https://cinemint.online/dendy/"

// --- DATA MODELS ---
data class AppModel(
    val name: String,
    @SerializedName("package_name") val packageName: String,
    val version: String,
    @SerializedName("version_code") val versionCode: Int,
    @SerializedName("download_url") val downloadUrl: String,
    @SerializedName("icon_url") val iconUrl: String
) : java.io.Serializable

// --- RETROFIT SERVICE ---
interface ApiService {
    @GET("api/list")
    suspend fun getApps(): List<AppModel>
}

object RetrofitClient {
    val api: ApiService by lazy {
        Retrofit.Builder()
            .baseUrl(BASE_URL)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
            .create(ApiService::class.java)
    }
}