activity_main.xml: 
<?xml version="1.0" encoding="utf-8"?>
<androidx.constraintlayout.widget.ConstraintLayout
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:padding="16dp">

    <TextView
        android:id="@+id/tvTitle"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Store"
        android:textSize="24sp"
        android:textStyle="bold"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toTopOf="parent" />

    <androidx.recyclerview.widget.RecyclerView
        android:id="@+id/recyclerView"
        android:layout_width="0dp"
        android:layout_height="0dp"
        android:layout_marginTop="16dp"
        app:layout_constraintBottom_toBottomOf="parent"
        app:layout_constraintEnd_toEndOf="parent"
        app:layout_constraintStart_toStartOf="parent"
        app:layout_constraintTop_toBottomOf="@id/tvTitle" />

</androidx.constraintlayout.widget.ConstraintLayout>

item_app.xml: 
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical"
    android:gravity="center"
    android:padding="16dp">

    <ImageView
        android:id="@+id/imgIcon"
        android:layout_width="64dp"
        android:layout_height="64dp"
        android:src="@mipmap/ic_launcher" />

    <TextView
        android:id="@+id/tvAppName"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="App Name"
        android:textStyle="bold" />
</LinearLayout>

activity_details.xml: 
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:gravity="center_horizontal"
    android:orientation="vertical"
    android:padding="32dp">

    <ImageView
        android:id="@+id/imgDetailIcon"
        android:layout_width="120dp"
        android:layout_height="120dp"
        android:src="@mipmap/ic_launcher" />

    <TextView
        android:id="@+id/tvDetailName"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="16dp"
        android:text="App Name"
        android:textSize="28sp"
        android:textStyle="bold" />

    <TextView
        android:id="@+id/tvDetailVersion"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="v1.0"
        android:textColor="#666" />

    <ProgressBar
        android:id="@+id/progressBar"
        style="?android:attr/progressBarStyleHorizontal"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="32dp"
        android:indeterminate="false"
        android:max="100"
        android:visibility="invisible" />

    <TextView
        android:id="@+id/tvStatus"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="4dp"
        android:text="0%"
        android:textSize="12sp"
        android:visibility="invisible"/>

    <Button
        android:id="@+id/btnAction"
        android:layout_width="match_parent"
        android:layout_height="60dp"
        android:layout_marginTop="16dp"
        android:text="Check Status" />

</LinearLayout>

Network.kt: 
package com.dendy.market

import com.google.gson.annotations.SerializedName
import retrofit2.Retrofit
import retrofit2.converter.gson.GsonConverterFactory
import retrofit2.http.GET

// --- CONFIGURATION ---
const val BASE_URL = "http://192.168.1.100:5000" // CHANGE THIS TO YOUR SERVER IP

// --- DATA MODELS ---
data class AppModel(
    val name: String,
    @SerializedName("package_name") val packageName: String,
    val version: String,
    @SerializedName("version_code") val versionCode: Int,
    @SerializedName("download_url") val downloadUrl: String,
    @SerializedName("icon_url") val iconUrl: String
) : java.io.Serializable

// --- RETROFIT SERVICE ---
interface ApiService {
    @GET("/api/list")
    suspend fun getApps(): List<AppModel>
}

object RetrofitClient {
    val api: ApiService by lazy {
        Retrofit.Builder()
            .baseUrl(BASE_URL)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
            .create(ApiService::class.java)
    }
}

MainActivity.kt: 
package com.dendy.market

import android.content.Intent
import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ImageView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.GridLayoutManager
import androidx.recyclerview.widget.RecyclerView
import coil.load
import kotlinx.coroutines.launch

class MainActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        val recycler = findViewById<RecyclerView>(R.id.recyclerView)
        recycler.layoutManager = GridLayoutManager(this, 3) // 3 columns

        lifecycleScope.launch {
            try {
                val apps = RetrofitClient.api.getApps()
                recycler.adapter = AppsAdapter(apps) { app ->
                    val intent = Intent(this@MainActivity, DetailsActivity::class.java)
                    intent.putExtra("APP_DATA", app)
                    startActivity(intent)
                }
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }

    class AppsAdapter(
        private val apps: List<AppModel>,
        private val onClick: (AppModel) -> Unit
    ) : RecyclerView.Adapter<AppsAdapter.Holder>() {

        class Holder(v: View) : RecyclerView.ViewHolder(v) {
            val icon: ImageView = v.findViewById(R.id.imgIcon)
            val name: TextView = v.findViewById(R.id.tvAppName)
        }

        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): Holder {
            val v = LayoutInflater.from(parent.context).inflate(R.layout.item_app, parent, false)
            return Holder(v)
        }

        override fun onBindViewHolder(holder: Holder, position: Int) {
            val app = apps[position]
            holder.name.text = app.name
            // Construct full icon URL
            val fullIconUrl = BASE_URL + app.iconUrl
            holder.icon.load(fullIconUrl)
            holder.itemView.setOnClickListener { onClick(app) }
        }

        override fun getItemCount() = apps.size
    }
}

DetailsActivity.kt: 
package com.dendy.market

import android.annotation.SuppressLint
import android.app.DownloadManager
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.IntentFilter
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Bundle
import android.os.Environment
import android.view.View
import android.widget.Button
import android.widget.ImageView
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.content.FileProvider
import androidx.lifecycle.lifecycleScope
import coil.load
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import kotlinx.coroutines.isActive
import kotlinx.coroutines.launch
import java.io.File

class DetailsActivity : AppCompatActivity() {

    private lateinit var appData: AppModel
    private lateinit var btnAction: Button
    private lateinit var progressBar: ProgressBar
    private lateinit var tvStatus: TextView
    private var progressJob: Job? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_details)

        appData = intent.getSerializableExtra("APP_DATA") as AppModel

        val imgIcon = findViewById<ImageView>(R.id.imgDetailIcon)
        val tvName = findViewById<TextView>(R.id.tvDetailName)
        val tvVersion = findViewById<TextView>(R.id.tvDetailVersion)
        btnAction = findViewById(R.id.btnAction)
        progressBar = findViewById(R.id.progressBar)
        tvStatus = findViewById(R.id.tvStatus)

        tvName.text = appData.name
        tvVersion.text = "Version: ${appData.version}"
        imgIcon.load(BASE_URL + appData.iconUrl)

        // 1. Initial State Check
        refreshUiState()

        // 2. Listen for install completion (to refresh button from "Installing" to "Open")
        registerReceiver(onDownloadComplete, IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE))
    }

    override fun onResume() {
        super.onResume()
        // If we left the screen and came back, refresh state immediately
        refreshUiState()
    }

    override fun onDestroy() {
        super.onDestroy()
        progressJob?.cancel()
        unregisterReceiver(onDownloadComplete)
    }

    // --- LOGIC CORE ---

    private fun refreshUiState() {
        // CASE A: Currently Downloading
        if (DownloadController.isDownloading(appData.packageName)) {
            setupDownloadingState()
            return
        }

        // CASE B: Not Downloading (Idle)
        progressBar.visibility = View.INVISIBLE
        tvStatus.visibility = View.INVISIBLE
        progressJob?.cancel() // Stop polling if we aren't downloading

        val installedCode = getInstalledVersionCode(appData.packageName)

        if (installedCode == -1) {
            // Not Installed
            btnAction.text = "Install"
            btnAction.isEnabled = true
            btnAction.setOnClickListener { startDownload() }
        } else if (appData.versionCode > installedCode) {
            // Update Available
            btnAction.text = "Update"
            btnAction.isEnabled = true
            btnAction.setOnClickListener { startDownload() }
        } else {
            // Up to Date
            btnAction.text = "Open"
            btnAction.isEnabled = true
            btnAction.setOnClickListener {
                val launchIntent = packageManager.getLaunchIntentForPackage(appData.packageName)
                if (launchIntent != null) {
                    startActivity(launchIntent)
                } else {
                    Toast.makeText(this, "Unable to launch app", Toast.LENGTH_SHORT).show()
                }
            }
        }
    }

    private fun setupDownloadingState() {
        btnAction.text = "Downloading..."
        btnAction.isEnabled = false // Disable button so they can't click it twice
        progressBar.visibility = View.VISIBLE
        tvStatus.visibility = View.VISIBLE

        // Start polling for progress
        startProgressPoller()
    }

    // --- DOWNLOAD & INSTALLATION ---

    private fun startDownload() {
        // QoL: Delete old file first to avoid "app-1.apk", "app-2.apk" clutter
        deleteExistingApk()

        Toast.makeText(this, "Starting Download...", Toast.LENGTH_SHORT).show()

        val fullDownloadUrl = BASE_URL + appData.downloadUrl
        val fileName = "${appData.packageName}.apk"

        val request = DownloadManager.Request(Uri.parse(fullDownloadUrl))
            .setTitle(appData.name)
            .setDescription("Downloading update...")
            .setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE) // Don't notify completed, we handle it
            .setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, fileName)
            .setMimeType("application/vnd.android.package-archive")

        val manager = getSystemService(Context.DOWNLOAD_SERVICE) as DownloadManager
        val downloadId = manager.enqueue(request)

        // Track state in Singleton
        DownloadController.trackDownload(appData.packageName, downloadId)

        refreshUiState()
    }

    private fun deleteExistingApk() {
        val fileName = "${appData.packageName}.apk"
        val file = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), fileName)
        if (file.exists()) {
            file.delete()
        }
    }

    private fun installApk() {
        val fileName = "${appData.packageName}.apk"
        val file = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), fileName)

        if (file.exists()) {
            val uri = FileProvider.getUriForFile(this, "${applicationContext.packageName}.provider", file)
            val intent = Intent(Intent.ACTION_VIEW).apply {
                setDataAndType(uri, "application/vnd.android.package-archive")
                addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }
            startActivity(intent)
        }
    }

    // --- PROGRESS POLLING ---

    @SuppressLint("Range")
    private fun startProgressPoller() {
        if (progressJob?.isActive == true) return // Already polling

        val downloadId = DownloadController.getDownloadId(appData.packageName) ?: return
        val manager = getSystemService(Context.DOWNLOAD_SERVICE) as DownloadManager

        progressJob = lifecycleScope.launch {
            while (isActive) {
                val query = DownloadManager.Query().setFilterById(downloadId)
                val cursor = manager.query(query)

                if (cursor.moveToFirst()) {
                    val status = cursor.getInt(cursor.getColumnIndex(DownloadManager.COLUMN_STATUS))

                    if (status == DownloadManager.STATUS_SUCCESSFUL) {
                        progressBar.progress = 100
                        tvStatus.text = "100%"
                        btnAction.text = "Installing..."
                        // We wait for the BroadcastReceiver to trigger the install
                        break
                    } else if (status == DownloadManager.STATUS_FAILED) {
                        btnAction.text = "Retry"
                        btnAction.isEnabled = true
                        DownloadController.clearDownload(appData.packageName)
                        break
                    } else {
                        // Calculate Progress
                        val bytesDownloaded = cursor.getLong(cursor.getColumnIndex(DownloadManager.COLUMN_BYTES_DOWNLOADED_SO_FAR))
                        val bytesTotal = cursor.getLong(cursor.getColumnIndex(DownloadManager.COLUMN_TOTAL_SIZE_BYTES))

                        if (bytesTotal > 0) {
                            val progress = ((bytesDownloaded * 100L) / bytesTotal).toInt()
                            progressBar.progress = progress
                            tvStatus.text = "$progress%"
                        }
                    }
                } else {
                    // Download cancelled or lost
                    DownloadController.clearDownload(appData.packageName)
                    refreshUiState()
                    break
                }
                cursor.close()
                delay(500) // Poll every 0.5 seconds
            }
        }
    }

    // --- SYSTEM EVENTS ---

    private val onDownloadComplete = object : BroadcastReceiver() {
        override fun onReceive(context: Context, intent: Intent) {
            val id = intent.getLongExtra(DownloadManager.EXTRA_DOWNLOAD_ID, -1)
            // Check if the finished download matches THIS app
            if (id == DownloadController.getDownloadId(appData.packageName)) {
                DownloadController.clearDownload(appData.packageName)
                installApk()
                refreshUiState() // This will likely switch button to "Open" or "Install" depending on if user completes install
            }
        }
    }

    private fun getInstalledVersionCode(packageName: String): Int {
        return try {
            val pInfo = packageManager.getPackageInfo(packageName, 0)
            pInfo.versionCode
        } catch (e: PackageManager.NameNotFoundException) {
            -1
        }
    }
}

DownloadController.kt: 
package com.dendy.market

object DownloadController {
    // Maps Package Name -> DownloadManager ID
    private val activeDownloads = mutableMapOf<String, Long>()

    fun isDownloading(packageName: String): Boolean {
        return activeDownloads.containsKey(packageName)
    }

    fun getDownloadId(packageName: String): Long? {
        return activeDownloads[packageName]
    }

    fun trackDownload(packageName: String, id: Long) {
        activeDownloads[packageName] = id
    }

    fun clearDownload(packageName: String) {
        activeDownloads.remove(packageName)
    }
}